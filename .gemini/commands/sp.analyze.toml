description = "Perform a non-destructive cross-artifact consistency and quality analysis for the Book RAG project."

prompt = """
---
description: Perform a non-destructive cross-artifact consistency and quality analysis for the Book RAG project.
---

## User Input

```text
$ARGUMENTS
```

You **MUST** consider the user input before proceeding (if not empty).

## Goal

Identify inconsistencies, duplications, ambiguities, and underspecified items across the three core artifacts (`spec.md`, `plan.md`, `tasks.md`) before implementing features for the Book RAG project. This command MUST run only after `/sp.tasks` has successfully produced a complete `tasks.md`.

## Operating Constraints

**STRICTLY READ-ONLY**: Do **not** modify any files. Output a structured analysis report. Offer an optional remediation plan (user must explicitly approve before any follow-up editing commands would be invoked manually).

**Constitution Authority**: The project constitution (`.specify/memory/constitution.md`) for the Book RAG project is **non-negotiable**. Any conflicts with the principles of using Docusaurus, Gemini, Neon, or Qdrant are automatically CRITICAL.

## Execution Steps

### 1. Initialize Analysis Context

Run `.specify/scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks` once from repo root and parse JSON for FEATURE_DIR and AVAILABLE_DOCS. Derive absolute paths:

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

Abort with an error message if any required file is missing (instruct the user to run missing prerequisite command).
For single quotes in args like "I'm Groot", use escape syntax: e.g 'I'\''m Groot' (or double-quote if possible: "I'm Groot").

### 2. Load Artifacts (Progressive Disclosure)

Load only the minimal necessary context from each artifact:

**From spec.md:**

- Overview/Context
- Functional Requirements (e.g., chat interaction, search accuracy)
- Non-Functional Requirements (e.g., query latency, embedding speed)
- User Stories
- Edge Cases (e.g., no search results, model hallucination)

**From plan.md:**

- Architecture/stack choices (Docusaurus, Gemini, Neon, Qdrant)
- Data Model references (relational schema in Neon, vector schema in Qdrant)
- Phases
- Technical constraints

**From tasks.md:**

- Task IDs
- Descriptions
- Phase grouping
- Parallel markers [P]
- Referenced file paths (e.g., `src/components/ChatWidget.tsx`)

**From constitution:**

- Load `.specify/memory/constitution.md` for principle validation.

### 3. Build Semantic Models

Create internal representations:

- **Requirements inventory**: Each functional + non-functional requirement related to the book and RAG system.
- **User story/action inventory**: Discrete user actions (e.g., "user asks a question", "user authenticates").
- **Task coverage mapping**: Map each task to one or more requirements or stories.
- **Constitution rule set**: Extract principles about Docusaurus, AI interactivity, data layer, etc.

### 4. Detection Passes (Token-Efficient Analysis)

Focus on high-signal findings. Limit to 50 findings total.

#### A. Duplication Detection

- Identify near-duplicate requirements for chat or search functionality.

#### B. Ambiguity Detection

- Flag vague adjectives (e.g., "fast search", "relevant answers") lacking measurable criteria (e.g., p95 latency, recall score).
- Flag unresolved placeholders (TODO, TKTK, ???).

#### C. Underspecification

- Requirements for the RAG pipeline without clear acceptance criteria.
- Tasks referencing components not defined in the Docusaurus plan.

#### D. Constitution Alignment

- Any plan element conflicting with the core principles (e.g., not using the specified tech stack).
- Missing mandated sections or quality gates from the constitution.

#### E. Coverage Gaps

- RAG requirements with zero associated tasks.
- Tasks that don't map to a specific user story or requirement.

#### F. Inconsistency

- Terminology drift (e.g., "embedding" vs. "vector").
- Data entities in Neon DB plan not matching the spec.
- Contradicting requirements (e.g., one requires real-time indexing, another allows for batch processing).

### 5. Severity Assignment

- **CRITICAL**: Violates a core constitution principle (e.g., not using the specified tech stack).
- **HIGH**: Ambiguous requirement for a core feature like search relevance.
- **MEDIUM**: Terminology drift, missing task coverage for a non-critical feature.
- **LOW**: Style/wording improvements.

### 6. Produce Compact Analysis Report

Output a Markdown report with the findings.

### 7. Provide Next Actions

At the end of the report, output a concise Next Actions block.

### 8. Offer Remediation

Ask the user: "Would you like me to suggest concrete remediation edits for the top N issues?" (Do NOT apply them automatically.)

## Operating Principles

- **NEVER modify files**.
- **Prioritize constitution violations**.
- **Report zero issues gracefully**.

## Context

{{args}}

---

As the main request completes, you MUST create and complete a PHR (Prompt History Record).

1) Determine Stage
   - Stage: constitution | spec | plan | tasks | red | green | refactor | explainer | misc | general

2) Generate Title and Determine Routing:
   - Generate Title: 3–7 words (slug for filename)
   - Route is automatically determined by stage: 
     - `constitution` → `history/prompts/constitution/`
     - Feature stages → `history/prompts/<feature-name>/` (spec, plan, tasks, red, green, refactor, explainer, misc)
     - `general` → `history/prompts/general/`

3) Create and Fill PHR (Shell first; fallback agent‑native)
   - Run: `.specify/scripts/bash/create-phr.sh --title "<title>" --stage <stage> [--feature <name>] --json`
   - Open the file and fill remaining placeholders (YAML + body), embedding full PROMPT_TEXT (verbatim) and concise RESPONSE_TEXT.
   - If the script fails:
     - Read `.specify/templates/phr-template.prompt.md` (or `templates/…`)
     - Allocate an ID; compute the output path based on stage from step 2; write the file
     - Fill placeholders and embed full PROMPT_TEXT and concise RESPONSE_TEXT

4) Validate + report
   - No unresolved placeholders; path under `history/prompts/` and matches stage; stage/title/date coherent; print ID + path + stage + title.
   - On failure: warn, don't block. Skip only for `/sp.phr`.
"